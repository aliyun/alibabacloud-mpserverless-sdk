!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("@alicloud/mpserverless-core")):"function"==typeof define&&define.amd?define(["@alicloud/mpserverless-core"],t):"object"==typeof exports?exports["@alicloud/mp-db-service"]=t(require("@alicloud/mpserverless-core")):e["@alicloud/mp-db-service"]=t(e["@alicloud/mpserverless-core"])}(this,(function(e){return function(e){var t={};function n(r){if(t[r])return t[r].exports;var o=t[r]={i:r,l:!1,exports:{}};e[r].call(o.exports,o,o.exports,n);o.l=!0;return o.exports}n.m=e;n.c=t;n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})};n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"});Object.defineProperty(e,"__esModule",{value:!0})};n.t=function(e,t){1&t&&(e=n(e));if(8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);n.r(r);Object.defineProperty(r,"default",{enumerable:!0,value:e});if(2&t&&"string"!=typeof e)for(var o in e)n.d(r,o,function(t){return e[t]}.bind(null,o));return r};n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};n.d(t,"a",t);return t};n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)};n.p="";return n(n.s="./src/index.ts")}({"./src/index.ts":function(e,t,n){"use strict";n.r(t);n.d(t,"DbService",(function(){return Ve}));var r=n("@alicloud/mpserverless-core");function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1;r.configurable=!0;"value"in r&&(r.writable=!0);Object.defineProperty(e,r.key,r)}}function u(e,t,n){t&&i(e.prototype,t);n&&i(e,n);return e}function c(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}});t&&a(e,t)}function a(e,t){return(a=Object.setPrototypeOf||function(e,t){e.__proto__=t;return e})(e,t)}function s(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{Date.prototype.toString.call(Reflect.construct(Date,[],(function(){})));return!0}catch(e){return!1}}();return function(){var n,r=l(e);if(t){var o=l(this).constructor;n=Reflect.construct(r,arguments,o)}else n=r.apply(this,arguments);return f(this,n)}}function f(e,t){return!t||"object"!==p(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function l(e){return(l=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function p(e){return(p="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var y=["i","m","u","g"];function h(e){return Array.isArray(e)}function d(e){return null!==e&&"object"===p(e)&&!h(e)}function v(e){return"string"==typeof e||function(e,t){return Object.prototype.toString.call(e)==="[object ".concat(t,"]")}(e,"String")}var m=function(e){c(n,e);var t=s(n);function n(){o(this,n);return t.apply(this,arguments)}u(n,[{key:"encode",value:function(e){var t=this;return e instanceof RegExp?this.toRegexp(e):e instanceof Date?this.toDate(e):h(e)?e.map((function(e){return t.encode(e)})):d(e)?Object.keys(e).reduce((function(n,r){n[r]=t.encode(e[r]);return n}),{}):e}},{key:"toDate",value:function(e){return e.toISOString()}},{key:"toRegexp",value:function(e){return"/".concat(e.source.replace(/\\\//g,"/"),"/").concat(e.flags)}}]);return n}(r.BaseEncoder),b=function(e){c(n,e);var t=s(n);function n(){o(this,n);return t.apply(this,arguments)}u(n,[{key:"decode",value:function(e){var t=this;return this.isDate(e)?this.toDate(e):h(e)?e.map((function(e){return t.decode(e)})):d(e)?Object.keys(e).reduce((function(n,r){n[r]=t.decode(e[r]);return n}),{}):e}},{key:"isDate",value:function(e){return v(e)&&/^\d{4}\-\d{2}\-\d{2}T\d{2}:\d{2}:\d{2}\.\d{3}Z$/.test(e)&&!isNaN(Date.parse(e))}},{key:"isRegexp",value:function(e){if(v(e)){var t=!0,n=e.split("/"),r=n[n.length-1];r&&(t=r.split("").reduce((function(e,t){return!0===e&&y.indexOf(t)>-1}),!0));return n.length>=2&&t}return!1}},{key:"toDate",value:function(e){return new Date(e)}},{key:"toRegexp",value:function(e){var t=e.indexOf("/"),n=e.lastIndexOf("/");return new RegExp(e.slice(t+1,n),e.slice(n+1))}}]);return n}(r.BaseDecoder);function g(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1;r.configurable=!0;"value"in r&&(r.writable=!0);Object.defineProperty(e,r.key,r)}}var O,w=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e);!function(e,t,n){t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n}(this,"name",void 0);this.name=t}!function(e,t,n){t&&g(e.prototype,t);n&&g(e,n)}(e,[{key:"inspect",value:function(){return{collection:this.name}}}]);return e}();!function(e){e.READ=".read";e.WRITE=".write";e.CREATE="document.create";e.UPDATE="document.update";e.DELETE="document.delete";e.AGGREGATE=".aggregate"}(O||(O={}));function E(e){return(E="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function j(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}});t&&_(e,t)}function _(e,t){return(_=Object.setPrototypeOf||function(e,t){e.__proto__=t;return e})(e,t)}function A(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{Date.prototype.toString.call(Reflect.construct(Date,[],(function(){})));return!0}catch(e){return!1}}();return function(){var n,r=P(e);if(t){var o=P(this).constructor;n=Reflect.construct(r,arguments,o)}else n=r.apply(this,arguments);return T(this,n)}}function T(e,t){return!t||"object"!==E(t)&&"function"!=typeof t?R(e):t}function R(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function P(e){return(P=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function S(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})));n.push.apply(n,r)}return n}function k(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?S(Object(n),!0).forEach((function(t){x(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):S(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function D(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function q(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1;r.configurable=!0;"value"in r&&(r.writable=!0);Object.defineProperty(e,r.key,r)}}function x(e,t,n){t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n;return e}var I=function(){function e(t){D(this,e);x(this,"name",void 0);x(this,"_schema",{});x(this,"_argMap",{});x(this,"_permission",void 0);this._argMap=t;this._argMap.options||(this._argMap.options={})}!function(e,t,n){t&&q(e.prototype,t);n&&q(e,n)}(e,[{key:"augmentOptions",value:function(e){this.argMap.options=Object.assign({},this.argMap.options,e)}},{key:"inspect",value:function(){return k(k({},function e(t){for(var n=0,r=Object.keys(t);n<r.length;n++){var o=r[n];d(t[o])&&(0===Object.keys(t[o]).length?"{}"!==JSON.stringify(t[o])&&delete t[o]:e(t[o]));void 0===t[o]&&delete t[o]}return t}(JSON.parse(JSON.stringify(this.argMap)))),{},{command:this.name})}},{key:"permission",get:function(){switch(this._permission){case O.CREATE:case O.UPDATE:case O.DELETE:return O.WRITE;default:return this._permission}}},{key:"argMap",get:function(){return this._argMap}},{key:"schema",get:function(){return this._schema}}]);return e}(),N=function(e){j(n,e);var t=A(n);function n(){var e;D(this,n);for(var r=arguments.length,o=new Array(r),i=0;i<r;i++)o[i]=arguments[i];x(R(e=t.call.apply(t,[this].concat(o))),"name","aggregate");x(R(e),"_schema",{pipeline:"array",options:{type:"object",required:!1,rule:{explain:{type:"boolean",required:!1},allowDiskUse:{type:"boolean",required:!1},maxTimeMS:{type:"int",required:!1,min:0},bypassDocumentValidation:{type:"boolean",required:!1},raw:{type:"boolean",required:!1},promoteLongs:{type:"boolean",required:!1},promoteValues:{type:"boolean",required:!1},promoteBuffers:{type:"boolean",required:!1},collation:{type:"object",required:!1}}}});x(R(e),"_permission",O.AGGREGATE);return e}return n}(I),M=function(e){j(n,e);var t=A(n);function n(){var e;D(this,n);for(var r=arguments.length,o=new Array(r),i=0;i<r;i++)o[i]=arguments[i];x(R(e=t.call.apply(t,[this].concat(o))),"name","count");x(R(e),"_schema",{query:"object",options:{type:"object",required:!1,rule:{limit:{type:"int",required:!1,min:0},skip:{type:"int",required:!1,min:0},maxTimeMS:{type:"int",required:!1,min:0}}}});x(R(e),"_permission",O.READ);return e}return n}(I),L=function(e){j(n,e);var t=A(n);function n(){var e;D(this,n);for(var r=arguments.length,o=new Array(r),i=0;i<r;i++)o[i]=arguments[i];x(R(e=t.call.apply(t,[this].concat(o))),"name","distinct");x(R(e),"_schema",{key:"string",query:"object",options:{type:"object",required:!1}});x(R(e),"_permission",O.READ);return e}return n}(I),C=function(e){j(n,e);var t=A(n);function n(){var e;D(this,n);for(var r=arguments.length,o=new Array(r),i=0;i<r;i++)o[i]=arguments[i];x(R(e=t.call.apply(t,[this].concat(o))),"name","findOne");x(R(e),"_schema",{query:{type:"object",required:!1},options:{type:"object",required:!1,rule:{limit:{type:"int",required:!1,min:0},skip:{type:"int",required:!1,min:0},maxTimeMS:{type:"int",required:!1,min:0},sort:{type:"sort",required:!1},projection:{type:"projection",required:!1},hint:{type:"object",required:!1}}}});x(R(e),"_permission",O.READ);return e}return n}(I),Y=function(e){j(n,e);var t=A(n);function n(){var e;D(this,n);for(var r=arguments.length,o=new Array(r),i=0;i<r;i++)o[i]=arguments[i];x(R(e=t.call.apply(t,[this].concat(o))),"name","find");x(R(e),"_schema",{query:{type:"object",required:!1},options:{type:"object",required:!1,rule:{limit:{type:"int",required:!1,min:0},skip:{type:"int",required:!1,min:0},maxTimeMS:{type:"int",required:!1,min:0},sort:{type:"sort",required:!1},projection:{type:"projection",required:!1},hint:{type:"object",required:!1}}}});x(R(e),"_permission",O.READ);return e}return n}(I),G=function(e){j(n,e);var t=A(n);function n(){var e;D(this,n);for(var r=arguments.length,o=new Array(r),i=0;i<r;i++)o[i]=arguments[i];x(R(e=t.call.apply(t,[this].concat(o))),"name","insertOne");x(R(e),"_schema",{doc:"field",options:{type:"object",required:!1}});x(R(e),"_permission",O.CREATE);return e}return n}(I),U=function(e){j(n,e);var t=A(n);function n(){var e;D(this,n);for(var r=arguments.length,o=new Array(r),i=0;i<r;i++)o[i]=arguments[i];x(R(e=t.call.apply(t,[this].concat(o))),"name","insertMany");x(R(e),"_schema",{docs:"fields",options:{type:"object",required:!1}});x(R(e),"_permission",O.CREATE);return e}return n}(I),V=function(e){j(n,e);var t=A(n);function n(){var e;D(this,n);for(var r=arguments.length,o=new Array(r),i=0;i<r;i++)o[i]=arguments[i];x(R(e=t.call.apply(t,[this].concat(o))),"name","findOneAndUpdate");x(R(e),"_schema",{filter:"object",update:"object",options:{type:"object",required:!1,rule:{maxTimeMS:{type:"int",min:0,required:!1},sort:{type:"sort",required:!1},upsert:{type:"boolean",required:!1},projection:{type:"projection",required:!1}}}});x(R(e),"_permission",O.UPDATE);return e}return n}(I),B=function(e){j(n,e);var t=A(n);function n(){var e;D(this,n);for(var r=arguments.length,o=new Array(r),i=0;i<r;i++)o[i]=arguments[i];x(R(e=t.call.apply(t,[this].concat(o))),"name","updateOne");x(R(e),"_schema",{filter:"object",update:"nobject",options:{type:"object",required:!1,rule:{upsert:{type:"boolean",required:!1}}}});x(R(e),"_permission",O.UPDATE);return e}return n}(I),F=function(e){j(n,e);var t=A(n);function n(){var e;D(this,n);for(var r=arguments.length,o=new Array(r),i=0;i<r;i++)o[i]=arguments[i];x(R(e=t.call.apply(t,[this].concat(o))),"name","updateMany");x(R(e),"_schema",{filter:"object",update:"nobject",options:{type:"object",required:!1,rule:{upsert:{type:"boolean",required:!1}}}});x(R(e),"_permission",O.UPDATE);return e}return n}(I),J=function(e){j(n,e);var t=A(n);function n(){var e;D(this,n);for(var r=arguments.length,o=new Array(r),i=0;i<r;i++)o[i]=arguments[i];x(R(e=t.call.apply(t,[this].concat(o))),"name","findOneAndReplace");x(R(e),"_schema",{filter:"object",replacement:"object",options:{type:"object",required:!1,rule:{maxTimeMS:{type:"int",min:0,required:!1},sort:{type:"sort",required:!1},upsert:{type:"boolean",required:!1},projection:{type:"projection",required:!1}}}});x(R(e),"_permission",O.UPDATE);return e}return n}(I),$=function(e){j(n,e);var t=A(n);function n(){var e;D(this,n);for(var r=arguments.length,o=new Array(r),i=0;i<r;i++)o[i]=arguments[i];x(R(e=t.call.apply(t,[this].concat(o))),"name","replaceOne");x(R(e),"_schema",{filter:"object",doc:"object",options:{type:"object",required:!1,rule:{upsert:{type:"boolean",required:!1}}}});x(R(e),"_permission",O.UPDATE);return e}return n}(I),K=function(e){j(n,e);var t=A(n);function n(){var e;D(this,n);for(var r=arguments.length,o=new Array(r),i=0;i<r;i++)o[i]=arguments[i];x(R(e=t.call.apply(t,[this].concat(o))),"name","findOneAndDelete");x(R(e),"_schema",{filter:"object",options:{type:"object",required:!1,rule:{maxTimeMS:{type:"int",min:0,required:!1},sort:{type:"sort",required:!1},projection:{type:"object",required:!1}}}});x(R(e),"_permission",O.DELETE);return e}return n}(I),W=function(e){j(n,e);var t=A(n);function n(){var e;D(this,n);for(var r=arguments.length,o=new Array(r),i=0;i<r;i++)o[i]=arguments[i];x(R(e=t.call.apply(t,[this].concat(o))),"name","deleteOne");x(R(e),"_schema",{filter:{type:"object"},options:{type:"object",required:!1}});x(R(e),"_permission",O.DELETE);return e}return n}(I),Z=function(e){j(n,e);var t=A(n);function n(){var e;D(this,n);for(var r=arguments.length,o=new Array(r),i=0;i<r;i++)o[i]=arguments[i];x(R(e=t.call.apply(t,[this].concat(o))),"name","deleteMany");x(R(e),"_schema",{filter:{type:"object"},options:{type:"object",required:!1}});x(R(e),"_permission",O.DELETE);return e}return n}(I),z=function(e){j(n,e);var t=A(n);function n(){var e;D(this,n);for(var r=arguments.length,o=new Array(r),i=0;i<r;i++)o[i]=arguments[i];x(R(e=t.call.apply(t,[this].concat(o))),"name","startTransaction");return e}return n}(I),H=function(e){j(n,e);var t=A(n);function n(){var e;D(this,n);for(var r=arguments.length,o=new Array(r),i=0;i<r;i++)o[i]=arguments[i];x(R(e=t.call.apply(t,[this].concat(o))),"name","commitTransaction");return e}return n}(I),Q=function(e){j(n,e);var t=A(n);function n(){var e;D(this,n);for(var r=arguments.length,o=new Array(r),i=0;i<r;i++)o[i]=arguments[i];x(R(e=t.call.apply(t,[this].concat(o))),"name","abortTransaction");return e}return n}(I);function X(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1;r.configurable=!0;"value"in r&&(r.writable=!0);Object.defineProperty(e,r.key,r)}}function ee(e,t,n){t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n;return e}var te,ne=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e);ee(this,"raw",void 0);ee(this,"encoder",new m);ee(this,"decoder",new b);this.raw=this.decoder.decode(t)}!function(e,t,n){t&&X(e.prototype,t);n&&X(e,n)}(e,[{key:"inspect",value:function(){return this.raw}}]);return e}();function re(e){return(re="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}!function(e){e.INVALID_TYPE="field type is invalid";e.NOT_ARRAY="field is not an array";e.ILLEGAL="field should not contain illegal character";e.ILLEGAL_VALUE="field should not contain undefined for a value";e.EMPTY_OBJECT="field should not be an empty object";e.NOT_OBJECT="should be an object";e.EMPTY="should not empty"}(te||(te={}));function oe(e,t,n){function r(e){if(/[\.\$]/.test(e))return te.ILLEGAL}if(!(t instanceof Object))return te.INVALID_TYPE;if(Array.isArray(t))return te.INVALID_TYPE;for(var o=0,i=Object.keys(t);o<i.length;o++){var u=i[o],c=r(u);if("string"==typeof c)return c;if(t[u]instanceof Object&&!Array.isArray(t[u])){var a=oe(e,t[u]);if(a)return a}}}var ie={ruleOfField:oe,ruleOfFields:function(e,t){if(!Array.isArray(t))return te.NOT_ARRAY;if(0===t.length)return te.EMPTY;for(var n,r=0;!n&&r<t.length;){n=oe(null,t[r],t[r]);r++}return n},ruleOfSort:function(e,t){var n=[1,-1];function r(e){if(/[\$]/.test(e))return te.ILLEGAL}if(!(t instanceof Object))return te.INVALID_TYPE;if("{}"!==JSON.stringify(t)){if(Array.isArray(t))return te.INVALID_TYPE;for(var o=null,i=0,u=Object.keys(t);i<u.length;i++){var c=u[i];if("string"==typeof(o=r(c)))return o;if(!n.includes(t[c]))return te.INVALID_TYPE}return null===o?te.INVALID_TYPE:void 0}},ruleOfProjection:function(e,t){var n=[1,0];function r(e){if(/[\$]/.test(e))return te.ILLEGAL}if(!(t instanceof Object))return te.INVALID_TYPE;if("{}"!==JSON.stringify(t)){if(Array.isArray(t))return te.INVALID_TYPE;for(var o=null,i=0,u=Object.keys(t);i<u.length;i++){var c=u[i];if("string"==typeof(o=r(c)))return o;if(!n.includes(t[c]))return te.INVALID_TYPE}return null===o?te.INVALID_TYPE:void 0}},ruleOfNobject:function(e,t){return"object"!==re(t)?te.NOT_OBJECT:0===Object.keys(t).length?te.EMPTY_OBJECT:void 0}};function ue(e){return(ue="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function ce(e,t){return(ce=Object.setPrototypeOf||function(e,t){e.__proto__=t;return e})(e,t)}function ae(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{Date.prototype.toString.call(Reflect.construct(Date,[],(function(){})));return!0}catch(e){return!1}}();return function(){var n,r=fe(e);if(t){var o=fe(this).constructor;n=Reflect.construct(r,arguments,o)}else n=r.apply(this,arguments);return se(this,n)}}function se(e,t){return!t||"object"!==ue(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function fe(e){return(fe=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var le=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}});t&&ce(e,t)}(n,e);var t=ae(n);function n(e){var r;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,n);r=t.call(this,e);for(var o=0,i=Object.keys(ie);o<i.length;o++){var u=i[o],c=u.match(/ruleOf([a-zA-Z]+)/)[1];r.p.addRule(c[0].toLowerCase()+c.slice(1),ie[u])}return r}return n}(r.Validator);const pe=Object(r.MPServerlessErrorClass)({TransactionError:{code:"TransactionError",message:"事务错误"}});function ye(e){return(ye="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function he(e,t,n){return(he="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=ge(e)););return e}(e,t);if(r){var o=Object.getOwnPropertyDescriptor(r,t);return o.get?o.get.call(n):o.value}})(e,t,n||e)}function de(e,t){return(de=Object.setPrototypeOf||function(e,t){e.__proto__=t;return e})(e,t)}function ve(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{Date.prototype.toString.call(Reflect.construct(Date,[],(function(){})));return!0}catch(e){return!1}}();return function(){var n,r=ge(e);if(t){var o=ge(this).constructor;n=Reflect.construct(r,arguments,o)}else n=r.apply(this,arguments);return me(this,n)}}function me(e,t){return!t||"object"!==ye(t)&&"function"!=typeof t?be(e):t}function be(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function ge(e){return(ge=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Oe(e,t,n,r,o,i,u){try{var c=e[i](u),a=c.value}catch(e){n(e);return}c.done?t(a):Promise.resolve(a).then(r,o)}function we(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var i=e.apply(t,n);function u(e){Oe(i,r,o,u,c,"next",e)}function c(e){Oe(i,r,o,u,c,"throw",e)}u(void 0)}))}}function Ee(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function je(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1;r.configurable=!0;"value"in r&&(r.writable=!0);Object.defineProperty(e,r.key,r)}}function _e(e,t,n){t&&je(e.prototype,t);n&&je(e,n);return e}function Ae(e,t,n){t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n;return e}var Te;!function(e){e.AGGREGATE="aggregate";e.COUNT="count";e.DISTINCT="distinct";e.FIND_ONE="findone";e.FIND="find";e.INSERT_ONE="insertOne";e.INSERT_MANY="insertMany";e.FIND_ONE_AND_UPDATE="findOneAndUpdate";e.UPDATE_ONE="updateOne";e.UPDATE_MANY="updateMany";e.FIND_ONE_AND_REPLACE="findOneAndReplace";e.REPLACE_ONE="replaceOne";e.FIND_ONE_AND_DELETE="findOneAndDelete";e.DELETE_ONE="deleteOne";e.DELETE_MANY="deleteMany"}(Te||(Te={}));var Re,Pe=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}});t&&de(e,t)}(n,e);var t=ve(n);function n(){var e;Ee(this,n);for(var r=arguments.length,o=new Array(r),i=0;i<r;i++)o[i]=arguments[i];Ae(be(e=t.call.apply(t,[this].concat(o))),"getEncoder",void 0);Ae(be(e),"getTransport",void 0);return e}_e(n,[{key:"execute",value:function(){var e=we(regeneratorRuntime.mark((function e(){var t,r,o;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.next=2;return he(ge(n.prototype),"execute",this).call(this);case 2:t=e.sent;r=this.getEncoder().setBodyField({method:"serverless.db.default.execute",params:t});e.next=6;return this.getTransport().request(r);case 6:o=e.sent;return e.abrupt("return",new ne(o.body).inspect());case 8:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()}]);return n}(function(){function e(){Ee(this,e);Ae(this,"transId",void 0);Ae(this,"coll",void 0);Ae(this,"comm",void 0);Ae(this,"encoder",new m);Ae(this,"decoder",new b)}_e(e,[{key:"transaction",value:function(){var e=we(regeneratorRuntime.mark((function e(){var t;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.comm=new z({});e.next=3;return this.execute();case 3:(t=e.sent)&&(this.transId=t.transactionId);return e.abrupt("return",this.transId);case 6:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"commit",value:function(){var e=we(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.comm=new H({});return e.abrupt("return",this.execute());case 2:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"rollback",value:function(){var e=we(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.comm=new Q({});return e.abrupt("return",this.execute());case 2:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"collection",value:function(e){this.coll=new w(e);return this}},{key:"aggregate",value:function(e,t){this.validateTransactionAction(Te.AGGREGATE);this.comm=new N({pipeline:e,options:t});return this.execute()}},{key:"count",value:function(e,t){this.validateTransactionAction(Te.COUNT);this.comm=new M({query:e,options:t});return this.execute()}},{key:"distinct",value:function(e,t,n){this.validateTransactionAction(Te.DISTINCT);this.comm=new L({key:e,query:t,options:n});return this.execute()}},{key:"findOne",value:function(e,t){this.comm=new C({query:e,options:t});return this.execute()}},{key:"find",value:function(e,t){this.validateTransactionAction(Te.FIND);this.comm=new Y({query:e,options:t});return this.execute()}},{key:"insertOne",value:function(e,t){this.comm=new G({doc:e,options:t});return this.execute()}},{key:"insertMany",value:function(e,t){this.validateTransactionAction(Te.INSERT_MANY);this.comm=new U({docs:e,options:t});return this.execute()}},{key:"findOneAndUpdate",value:function(e,t,n){this.comm=new V({filter:e,update:t,options:n});return this.execute()}},{key:"updateOne",value:function(e,t,n){this.comm=new B({filter:e,update:t,options:n});return this.execute()}},{key:"updateMany",value:function(e,t,n){this.validateTransactionAction(Te.UPDATE_MANY);this.comm=new F({filter:e,update:t,options:n});return this.execute()}},{key:"findOneAndReplace",value:function(e,t,n){this.comm=new J({filter:e,replacement:t,options:n});return this.execute()}},{key:"replaceOne",value:function(e,t,n){this.comm=new $({filter:e,doc:t,options:n});return this.execute()}},{key:"findOneAndDelete",value:function(e,t){this.comm=new K({filter:e,options:t});return this.execute()}},{key:"deleteOne",value:function(e,t){this.comm=new W({filter:e,options:t});return this.execute()}},{key:"deleteMany",value:function(e,t){this.validateTransactionAction(Te.DELETE_MANY);this.comm=new Z({filter:e,options:t});return this.execute()}},{key:"validate",value:function(){var e=new le;try{e.validate(this.comm.schema,this.encoder.encode(this.comm.argMap))}catch(e){throw e}}},{key:"execute",value:function(){var e=we(regeneratorRuntime.mark((function e(){var t;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:Object(r.assert)(this.comm,"[DBService]缺少 command 参数");this.validate();e.t0=this.comm.permission;e.next=e.t0===O.AGGREGATE||e.t0===O.WRITE||e.t0===O.READ?5:7;break;case 5:Object(r.assert)(this.collection,"[DBService]缺少 collection 参数");return e.abrupt("break",7);case 7:t=Object.assign({},this.coll&&this.coll.inspect(),this.transId&&{transactionId:this.transId},this.comm.inspect());return e.abrupt("return",this.encoder.encode(t));case 9:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"validateTransactionAction",value:function(e){if(this.transId)throw new pe.TransactionError("transaction not support action ["+e+"]")}}]);return e}());function Se(e,t,n,r,o,i,u){try{var c=e[i](u),a=c.value}catch(e){n(e);return}c.done?t(a):Promise.resolve(a).then(r,o)}function ke(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var i=e.apply(t,n);function u(e){Se(i,r,o,u,c,"next",e)}function c(e){Se(i,r,o,u,c,"throw",e)}u(void 0)}))}}function De(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1;r.configurable=!0;"value"in r&&(r.writable=!0);Object.defineProperty(e,r.key,r)}}function qe(e,t,n){t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n;return e}!function(e){e.INIT="init";e.COMMIT="commit";e.ROLLBACK="rollback"}(Re||(Re={}));var xe=function(){function e(t,n){var r=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e);qe(this,"id",void 0);qe(this,"status",void 0);qe(this,"httpTransport",void 0);qe(this,"httpRequestEncoder",void 0);qe(this,"queryService",void 0);this.status=Re.INIT;this.httpTransport=t;this.httpRequestEncoder=n;this.queryService=new Pe;this.queryService.getEncoder=function(){return r.httpRequestEncoder};this.queryService.getTransport=function(){return r.httpTransport}}!function(e,t,n){t&&De(e.prototype,t);n&&De(e,n)}(e,[{key:"init",value:function(){var e=ke(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.next=2;return this.queryService.transaction();case 2:this.id=e.sent;case 3:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"collection",value:function(e){this.queryService&&this.queryService.collection(e);return this.queryService}},{key:"commit",value:function(){var e=ke(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.checkStatus();this.status=Re.COMMIT;return e.abrupt("return",this.queryService.commit());case 3:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"rollback",value:function(){var e=ke(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.checkStatus();this.status=Re.ROLLBACK;return e.abrupt("return",this.queryService.rollback());case 3:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"checkStatus",value:function(){if(this.status===Re.COMMIT||this.status===Re.ROLLBACK)throw new pe.TransactionError("transaction already "+this.status)}}]);return e}();function Ie(e){return(Ie="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Ne(e,t,n,r,o,i,u){try{var c=e[i](u),a=c.value}catch(e){n(e);return}c.done?t(a):Promise.resolve(a).then(r,o)}function Me(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Le(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1;r.configurable=!0;"value"in r&&(r.writable=!0);Object.defineProperty(e,r.key,r)}}function Ce(e,t){return(Ce=Object.setPrototypeOf||function(e,t){e.__proto__=t;return e})(e,t)}function Ye(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{Date.prototype.toString.call(Reflect.construct(Date,[],(function(){})));return!0}catch(e){return!1}}();return function(){var n,r=Ue(e);if(t){var o=Ue(this).constructor;n=Reflect.construct(r,arguments,o)}else n=r.apply(this,arguments);return Ge(this,n)}}function Ge(e,t){return!t||"object"!==Ie(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Ue(e){return(Ue=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var Ve=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}});t&&Ce(e,t)}(n,e);var t=Ye(n);function n(){Me(this,n);return t.apply(this,arguments)}!function(e,t,n){t&&Le(e.prototype,t);n&&Le(e,n)}(n,[{key:"collection",value:function(e){var t=this,n=(new Pe).collection(e);n.getEncoder=function(){return t.getEncoder()};n.getTransport=function(){return t.transport};return n}},{key:"startTransaction",value:function(){var e=function(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var i=e.apply(t,n);function u(e){Ne(i,r,o,u,c,"next",e)}function c(e){Ne(i,r,o,u,c,"throw",e)}u(void 0)}))}}(regeneratorRuntime.mark((function e(){var t;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=new xe(this.transport,this.getEncoder());e.next=3;return t.init();case 3:return e.abrupt("return",t);case 4:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()}]);return n}(r.BaseService)},"@alicloud/mpserverless-core":function(t,n){t.exports=e}})}));