!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("@alicloud/mpserverless-core")):"function"==typeof define&&define.amd?define(["@alicloud/mpserverless-core"],t):"object"==typeof exports?exports["@alicloud/mp-file-service"]=t(require("@alicloud/mpserverless-core")):e["@alicloud/mp-file-service"]=t(e["@alicloud/mpserverless-core"])}(this,(function(e){return function(e){var t={};function i(a){if(t[a])return t[a].exports;var o=t[a]={i:a,l:!1,exports:{}};e[a].call(o.exports,o,o.exports,i);o.l=!0;return o.exports}i.m=e;i.c=t;i.d=function(e,t,a){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:a})};i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"});Object.defineProperty(e,"__esModule",{value:!0})};i.t=function(e,t){1&t&&(e=i(e));if(8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var a=Object.create(null);i.r(a);Object.defineProperty(a,"default",{enumerable:!0,value:e});if(2&t&&"string"!=typeof e)for(var o in e)i.d(a,o,function(t){return e[t]}.bind(null,o));return a};i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};i.d(t,"a",t);return t};i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)};i.p="";return i(i.s="./src/index.ts")}({"../../node_modules/mime/Mime.js":function(e,t,i){"use strict";function a(){this._types=Object.create(null);this._extensions=Object.create(null);for(var e=0;e<arguments.length;e++)this.define(arguments[e]);this.define=this.define.bind(this);this.getType=this.getType.bind(this);this.getExtension=this.getExtension.bind(this)}a.prototype.define=function(e,t){for(var i in e){var a=e[i].map((function(e){return e.toLowerCase()}));i=i.toLowerCase();for(var o=0;o<a.length;o++){if("*"!=(n=a[o])[0]){if(!t&&n in this._types)throw new Error('Attempt to change mapping for "'+n+'" extension from "'+this._types[n]+'" to "'+i+'". Pass `force=true` to allow this, otherwise remove "'+n+'" from the list of extensions for "'+i+'".');this._types[n]=i}}if(t||!this._extensions[i]){var n=a[0];this._extensions[i]="*"!=n[0]?n:n.substr(1)}}};a.prototype.getType=function(e){var t=(e=String(e)).replace(/^.*[/\\]/,"").toLowerCase(),i=t.replace(/^.*\./,"").toLowerCase(),a=t.length<e.length;return(i.length<t.length-1||!a)&&this._types[i]||null};a.prototype.getExtension=function(e){return(e=/^\s*([^;\s]*)/.test(e)&&RegExp.$1)&&this._extensions[e.toLowerCase()]||null};e.exports=a},"../../node_modules/mime/lite.js":function(e,t,i){"use strict";var a=i("../../node_modules/mime/Mime.js");e.exports=new a(i("../../node_modules/mime/types/standard.js"))},"../../node_modules/mime/types/standard.js":function(e,t){e.exports={"application/andrew-inset":["ez"],"application/applixware":["aw"],"application/atom+xml":["atom"],"application/atomcat+xml":["atomcat"],"application/atomdeleted+xml":["atomdeleted"],"application/atomsvc+xml":["atomsvc"],"application/atsc-dwd+xml":["dwd"],"application/atsc-held+xml":["held"],"application/atsc-rsat+xml":["rsat"],"application/bdoc":["bdoc"],"application/calendar+xml":["xcs"],"application/ccxml+xml":["ccxml"],"application/cdfx+xml":["cdfx"],"application/cdmi-capability":["cdmia"],"application/cdmi-container":["cdmic"],"application/cdmi-domain":["cdmid"],"application/cdmi-object":["cdmio"],"application/cdmi-queue":["cdmiq"],"application/cu-seeme":["cu"],"application/dash+xml":["mpd"],"application/davmount+xml":["davmount"],"application/docbook+xml":["dbk"],"application/dssc+der":["dssc"],"application/dssc+xml":["xdssc"],"application/ecmascript":["ecma","es"],"application/emma+xml":["emma"],"application/emotionml+xml":["emotionml"],"application/epub+zip":["epub"],"application/exi":["exi"],"application/fdt+xml":["fdt"],"application/font-tdpfr":["pfr"],"application/geo+json":["geojson"],"application/gml+xml":["gml"],"application/gpx+xml":["gpx"],"application/gxf":["gxf"],"application/gzip":["gz"],"application/hjson":["hjson"],"application/hyperstudio":["stk"],"application/inkml+xml":["ink","inkml"],"application/ipfix":["ipfix"],"application/its+xml":["its"],"application/java-archive":["jar","war","ear"],"application/java-serialized-object":["ser"],"application/java-vm":["class"],"application/javascript":["js","mjs"],"application/json":["json","map"],"application/json5":["json5"],"application/jsonml+json":["jsonml"],"application/ld+json":["jsonld"],"application/lgr+xml":["lgr"],"application/lost+xml":["lostxml"],"application/mac-binhex40":["hqx"],"application/mac-compactpro":["cpt"],"application/mads+xml":["mads"],"application/manifest+json":["webmanifest"],"application/marc":["mrc"],"application/marcxml+xml":["mrcx"],"application/mathematica":["ma","nb","mb"],"application/mathml+xml":["mathml"],"application/mbox":["mbox"],"application/mediaservercontrol+xml":["mscml"],"application/metalink+xml":["metalink"],"application/metalink4+xml":["meta4"],"application/mets+xml":["mets"],"application/mmt-aei+xml":["maei"],"application/mmt-usd+xml":["musd"],"application/mods+xml":["mods"],"application/mp21":["m21","mp21"],"application/mp4":["mp4s","m4p"],"application/mrb-consumer+xml":["*xdf"],"application/mrb-publish+xml":["*xdf"],"application/msword":["doc","dot"],"application/mxf":["mxf"],"application/n-quads":["nq"],"application/n-triples":["nt"],"application/node":["cjs"],"application/octet-stream":["bin","dms","lrf","mar","so","dist","distz","pkg","bpk","dump","elc","deploy","exe","dll","deb","dmg","iso","img","msi","msp","msm","buffer"],"application/oda":["oda"],"application/oebps-package+xml":["opf"],"application/ogg":["ogx"],"application/omdoc+xml":["omdoc"],"application/onenote":["onetoc","onetoc2","onetmp","onepkg"],"application/oxps":["oxps"],"application/p2p-overlay+xml":["relo"],"application/patch-ops-error+xml":["*xer"],"application/pdf":["pdf"],"application/pgp-encrypted":["pgp"],"application/pgp-signature":["asc","sig"],"application/pics-rules":["prf"],"application/pkcs10":["p10"],"application/pkcs7-mime":["p7m","p7c"],"application/pkcs7-signature":["p7s"],"application/pkcs8":["p8"],"application/pkix-attr-cert":["ac"],"application/pkix-cert":["cer"],"application/pkix-crl":["crl"],"application/pkix-pkipath":["pkipath"],"application/pkixcmp":["pki"],"application/pls+xml":["pls"],"application/postscript":["ai","eps","ps"],"application/provenance+xml":["provx"],"application/pskc+xml":["pskcxml"],"application/raml+yaml":["raml"],"application/rdf+xml":["rdf","owl"],"application/reginfo+xml":["rif"],"application/relax-ng-compact-syntax":["rnc"],"application/resource-lists+xml":["rl"],"application/resource-lists-diff+xml":["rld"],"application/rls-services+xml":["rs"],"application/route-apd+xml":["rapd"],"application/route-s-tsid+xml":["sls"],"application/route-usd+xml":["rusd"],"application/rpki-ghostbusters":["gbr"],"application/rpki-manifest":["mft"],"application/rpki-roa":["roa"],"application/rsd+xml":["rsd"],"application/rss+xml":["rss"],"application/rtf":["rtf"],"application/sbml+xml":["sbml"],"application/scvp-cv-request":["scq"],"application/scvp-cv-response":["scs"],"application/scvp-vp-request":["spq"],"application/scvp-vp-response":["spp"],"application/sdp":["sdp"],"application/senml+xml":["senmlx"],"application/sensml+xml":["sensmlx"],"application/set-payment-initiation":["setpay"],"application/set-registration-initiation":["setreg"],"application/shf+xml":["shf"],"application/sieve":["siv","sieve"],"application/smil+xml":["smi","smil"],"application/sparql-query":["rq"],"application/sparql-results+xml":["srx"],"application/srgs":["gram"],"application/srgs+xml":["grxml"],"application/sru+xml":["sru"],"application/ssdl+xml":["ssdl"],"application/ssml+xml":["ssml"],"application/swid+xml":["swidtag"],"application/tei+xml":["tei","teicorpus"],"application/thraud+xml":["tfi"],"application/timestamped-data":["tsd"],"application/toml":["toml"],"application/ttml+xml":["ttml"],"application/urc-ressheet+xml":["rsheet"],"application/voicexml+xml":["vxml"],"application/wasm":["wasm"],"application/widget":["wgt"],"application/winhlp":["hlp"],"application/wsdl+xml":["wsdl"],"application/wspolicy+xml":["wspolicy"],"application/xaml+xml":["xaml"],"application/xcap-att+xml":["xav"],"application/xcap-caps+xml":["xca"],"application/xcap-diff+xml":["xdf"],"application/xcap-el+xml":["xel"],"application/xcap-error+xml":["xer"],"application/xcap-ns+xml":["xns"],"application/xenc+xml":["xenc"],"application/xhtml+xml":["xhtml","xht"],"application/xliff+xml":["xlf"],"application/xml":["xml","xsl","xsd","rng"],"application/xml-dtd":["dtd"],"application/xop+xml":["xop"],"application/xproc+xml":["xpl"],"application/xslt+xml":["xslt"],"application/xspf+xml":["xspf"],"application/xv+xml":["mxml","xhvml","xvml","xvm"],"application/yang":["yang"],"application/yin+xml":["yin"],"application/zip":["zip"],"audio/3gpp":["*3gpp"],"audio/adpcm":["adp"],"audio/basic":["au","snd"],"audio/midi":["mid","midi","kar","rmi"],"audio/mobile-xmf":["mxmf"],"audio/mp3":["*mp3"],"audio/mp4":["m4a","mp4a"],"audio/mpeg":["mpga","mp2","mp2a","mp3","m2a","m3a"],"audio/ogg":["oga","ogg","spx"],"audio/s3m":["s3m"],"audio/silk":["sil"],"audio/wav":["wav"],"audio/wave":["*wav"],"audio/webm":["weba"],"audio/xm":["xm"],"font/collection":["ttc"],"font/otf":["otf"],"font/ttf":["ttf"],"font/woff":["woff"],"font/woff2":["woff2"],"image/aces":["exr"],"image/apng":["apng"],"image/bmp":["bmp"],"image/cgm":["cgm"],"image/dicom-rle":["drle"],"image/emf":["emf"],"image/fits":["fits"],"image/g3fax":["g3"],"image/gif":["gif"],"image/heic":["heic"],"image/heic-sequence":["heics"],"image/heif":["heif"],"image/heif-sequence":["heifs"],"image/hej2k":["hej2"],"image/hsj2":["hsj2"],"image/ief":["ief"],"image/jls":["jls"],"image/jp2":["jp2","jpg2"],"image/jpeg":["jpeg","jpg","jpe"],"image/jph":["jph"],"image/jphc":["jhc"],"image/jpm":["jpm"],"image/jpx":["jpx","jpf"],"image/jxr":["jxr"],"image/jxra":["jxra"],"image/jxrs":["jxrs"],"image/jxs":["jxs"],"image/jxsc":["jxsc"],"image/jxsi":["jxsi"],"image/jxss":["jxss"],"image/ktx":["ktx"],"image/png":["png"],"image/sgi":["sgi"],"image/svg+xml":["svg","svgz"],"image/t38":["t38"],"image/tiff":["tif","tiff"],"image/tiff-fx":["tfx"],"image/webp":["webp"],"image/wmf":["wmf"],"message/disposition-notification":["disposition-notification"],"message/global":["u8msg"],"message/global-delivery-status":["u8dsn"],"message/global-disposition-notification":["u8mdn"],"message/global-headers":["u8hdr"],"message/rfc822":["eml","mime"],"model/3mf":["3mf"],"model/gltf+json":["gltf"],"model/gltf-binary":["glb"],"model/iges":["igs","iges"],"model/mesh":["msh","mesh","silo"],"model/mtl":["mtl"],"model/obj":["obj"],"model/stl":["stl"],"model/vrml":["wrl","vrml"],"model/x3d+binary":["*x3db","x3dbz"],"model/x3d+fastinfoset":["x3db"],"model/x3d+vrml":["*x3dv","x3dvz"],"model/x3d+xml":["x3d","x3dz"],"model/x3d-vrml":["x3dv"],"text/cache-manifest":["appcache","manifest"],"text/calendar":["ics","ifb"],"text/coffeescript":["coffee","litcoffee"],"text/css":["css"],"text/csv":["csv"],"text/html":["html","htm","shtml"],"text/jade":["jade"],"text/jsx":["jsx"],"text/less":["less"],"text/markdown":["markdown","md"],"text/mathml":["mml"],"text/mdx":["mdx"],"text/n3":["n3"],"text/plain":["txt","text","conf","def","list","log","in","ini"],"text/richtext":["rtx"],"text/rtf":["*rtf"],"text/sgml":["sgml","sgm"],"text/shex":["shex"],"text/slim":["slim","slm"],"text/stylus":["stylus","styl"],"text/tab-separated-values":["tsv"],"text/troff":["t","tr","roff","man","me","ms"],"text/turtle":["ttl"],"text/uri-list":["uri","uris","urls"],"text/vcard":["vcard"],"text/vtt":["vtt"],"text/xml":["*xml"],"text/yaml":["yaml","yml"],"video/3gpp":["3gp","3gpp"],"video/3gpp2":["3g2"],"video/h261":["h261"],"video/h263":["h263"],"video/h264":["h264"],"video/jpeg":["jpgv"],"video/jpm":["*jpm","jpgm"],"video/mj2":["mj2","mjp2"],"video/mp2t":["ts"],"video/mp4":["mp4","mp4v","mpg4"],"video/mpeg":["mpeg","mpg","mpe","m1v","m2v"],"video/ogg":["ogv"],"video/quicktime":["qt","mov"],"video/webm":["webm"]}},"./src/index.ts":function(e,t,i){"use strict";i.r(t);i.d(t,"OSSUploadResponseFormat",(function(){return v}));i.d(t,"OSSUploadHeaderList",(function(){return b}));i.d(t,"WHITELIST_EXTENSIONS",(function(){return j}));i.d(t,"MPFileService",(function(){return w}));var a=i("@alicloud/mpserverless-core"),o={options:{type:"object",rule:{fileSize:{type:"int",required:!1,min:0},extension:{type:"enum",required:!1,values:[".jpg",".jpeg",".png",".gif",".image","jpg","jpeg","png","gif","image"]},filePath:{type:"string"},env:{type:"enum",required:!1,values:["public"]},timeout:{type:"int",required:!1,min:0},headers:{type:"object",required:!1,rules:{cacheControl:{type:"string",required:!1},contentDisposition:{type:"string",required:!1},contentEncoding:{type:"string",required:!1},expires:{type:"string",required:!1}}},meta:{type:"object",required:!1}}}},n={url:"url"},p=i("../../node_modules/mime/lite.js"),r=i.n(p),l=Object(a.MPServerlessErrorClass)({InterfaceError:{code:"InterfaceError",message:"接口响应失败"}});function s(e){return(s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function c(e,t,i,a,o,n,p){try{var r=e[n](p),l=r.value}catch(e){i(e);return}r.done?t(l):Promise.resolve(l).then(a,o)}function m(e){return function(){var t=this,i=arguments;return new Promise((function(a,o){var n=e.apply(t,i);function p(e){c(n,a,o,p,r,"next",e)}function r(e){c(n,a,o,p,r,"throw",e)}p(void 0)}))}}function u(e,t){for(var i=0;i<t.length;i++){var a=t[i];a.enumerable=a.enumerable||!1;a.configurable=!0;"value"in a&&(a.writable=!0);Object.defineProperty(e,a.key,a)}}function d(e,t){return(d=Object.setPrototypeOf||function(e,t){e.__proto__=t;return e})(e,t)}function f(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{Date.prototype.toString.call(Reflect.construct(Date,[],(function(){})));return!0}catch(e){return!1}}();return function(){var i,a=h(e);if(t){var o=h(this).constructor;i=Reflect.construct(a,arguments,o)}else i=a.apply(this,arguments);return x(this,i)}}function x(e,t){return!t||"object"!==s(t)&&"function"!=typeof t?g(e):t}function g(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function h(e){return(h=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function v(e){return{id:e.id,key:e.ossPath,host:e.host,policy:e.policy,Signature:e.signature,OSSAccessKeyId:e.accessKeyId,securityToken:e.securityToken,cdnDomain:e.cdnDomain}}var y,b=["Expires","Cache-Control","Content-Type","Content-Encoding","Content-Disposition"],j=["jpg","jpeg","png","gif","webp","svg","image"];!function(e){e.PUBLIC="public";e.PRIVATE="private"}(y||(y={}));var w=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}});t&&d(e,t)}(i,e);var t=f(i);function i(e,o){var n;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,i);!function(e,t,i){t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i}(g(n=t.call(this,e)),"upload",void 0);Object(a.assert)(o,"[MPFileService]初始化时缺少参数");Object(a.assert)(o.uploadFile,"[MPFileService]初始化时缺少 uploadFile 参数");n.upload=o.uploadFile;return n}!function(e,t,i){t&&u(e.prototype,t);i&&u(e,i)}(i,[{key:"deleteFile",value:function(){var e=m(regeneratorRuntime.mark((function e(t){var i,a;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.validate(n,{url:t});(i=this.getEncoder()).setBodyField({method:"serverless.file.resource.delete",params:{id:t}});e.next=5;return this.transport.request(i);case 5:a=e.sent;return e.abrupt("return",a.body);case 7:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"uploadFile",value:function(){var e=m(regeneratorRuntime.mark((function e(t){var i,n,p,s,c,m,u,d,f;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.validate(o,{options:t});i=t.filePath.replace(/(.*):\/\//,"");n=i.split(".").pop();Object(a.assert)(j.indexOf(n.toLowerCase())>=0,"[MPFileService]目前不支持 ".concat(n," 类型文件"));p=Object.keys(t.meta||{}).reduce((function(e,i){e["x-oss-meta-".concat(i)]=t.meta[i];return e}),{});s=t.headers?b.reduce((function(e,i){var a=i.replace(/\-[A-Z]/g,(function(e){return e[1]})).replace(/^[A-Z]/,(function(e){return e.toLowerCase()}));t.headers.hasOwnProperty(a)&&(e[i]=t.headers[a]);return e}),{}):{};e.next=8;return this.getOSSUploadOptionsFromPath(i,t.path,t.fileSize);case 8:if(!(c=e.sent).error){e.next=11;break}throw new l.InterfaceError;case 11:m=v(c.result);u=["key","policy","Signature","OSSAccessKeyId"].reduce((function(e,t){e[t]=m[t];return e}),{});d={"X-OSS-server-side-encrpytion":"AES256"};if(t.extension){f=r.a.getType(t.extension);d["Content-Type"]=f}s["Cache-Control"]="max-age=2592000";m.securityToken&&(s["x-oss-security-token"]=m.securityToken);e.next=19;return this.upload({url:"https://".concat(m.host),formData:Object.assign({success_action_status:200},s,p,u),name:"file",fileName:"file",filePath:t.filePath,fileType:"image",header:d});case 19:e.next=21;return this.reportOSSUpload(m.id,r.a.getType(t.extension));case 21:return e.abrupt("return",{fileUrl:"https://".concat(m.cdnDomain,"/").concat(m.key),filePath:m.key});case 22:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"getOSSUploadOptionsFromPath",value:function(){var e=m(regeneratorRuntime.mark((function e(t,i,a){var o,n,p;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:(o={env:y.PUBLIC}).filename=t.split("/").pop();o.size=a;i&&(o.targetPath=i);(n=this.getEncoder()).setBodyField({method:"serverless.file.resource.generateProximalSign",params:o});e.next=8;return this.transport.request(n);case 8:p=e.sent;return e.abrupt("return",p.body);case 10:case"end":return e.stop()}}),e,this)})));return function(t,i,a){return e.apply(this,arguments)}}()},{key:"reportOSSUpload",value:function(){var e=m(regeneratorRuntime.mark((function e(t,i){var a,o;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:a=this.transport.getEncoder();o={id:t};i&&(o.contentType=i);a.setBodyField({method:"serverless.file.resource.report",params:o});e.next=6;return this.transport.request(a);case 6:case"end":return e.stop()}}),e,this)})));return function(t,i){return e.apply(this,arguments)}}()},{key:"validate",value:function(e,t){var i=new a.Validator;try{i.validate(e,t)}catch(e){throw e}}}]);return i}(a.BaseService)},"@alicloud/mpserverless-core":function(t,i){t.exports=e}})}));