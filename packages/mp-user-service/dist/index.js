!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("@alicloud/mpserverless-core")):"function"==typeof define&&define.amd?define(["@alicloud/mpserverless-core"],t):"object"==typeof exports?exports["@alicloud/mp-user-service"]=t(require("@alicloud/mpserverless-core")):e["@alicloud/mp-user-service"]=t(e["@alicloud/mpserverless-core"])}(this,(function(e){return function(e){var t={};function r(n){if(t[n])return t[n].exports;var o=t[n]={i:n,l:!1,exports:{}};e[n].call(o.exports,o,o.exports,r);o.l=!0;return o.exports}r.m=e;r.c=t;r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})};r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"});Object.defineProperty(e,"__esModule",{value:!0})};r.t=function(e,t){1&t&&(e=r(e));if(8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);r.r(n);Object.defineProperty(n,"default",{enumerable:!0,value:e});if(2&t&&"string"!=typeof e)for(var o in e)r.d(n,o,function(t){return e[t]}.bind(null,o));return n};r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};r.d(t,"a",t);return t};r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)};r.p="";return r(r.s="./src/index.ts")}({"./src/index.ts":function(e,t,r){"use strict";r.r(t);r.d(t,"AuthType",(function(){return n}));r.d(t,"UserService",(function(){return O}));var n,o=r("@alicloud/mpserverless-core"),s={options:{type:"object",rule:{authType:{type:"enum",required:!1,values:["anonymous",""]},authProvider:{type:"enum",required:!1,values:["alipay_openapi","wechat_openapi","dingtalk_openapi"]}}}},i={options:{type:"object",required:!1,rule:{authProvider:{type:"enum",required:!1,values:["alipay_openapi","wechat_openapi","dingtalk_openapi"]}}}},u=Object(o.MPServerlessErrorClass)({UnauthorizedError:{code:"UnauthorizedError",message:"未授权错误"}});function a(e){return(a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function c(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})));r.push.apply(r,n)}return r}function p(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?c(Object(r),!0).forEach((function(t){g(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):c(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function f(e,t,r,n,o,s,i){try{var u=e[s](i),a=u.value}catch(e){r(e);return}u.done?t(a):Promise.resolve(a).then(n,o)}function l(e){return function(){var t=this,r=arguments;return new Promise((function(n,o){var s=e.apply(t,r);function i(e){f(s,n,o,i,u,"next",e)}function u(e){f(s,n,o,i,u,"throw",e)}i(void 0)}))}}function d(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1;n.configurable=!0;"value"in n&&(n.writable=!0);Object.defineProperty(e,n.key,n)}}function h(e,t){return(h=Object.setPrototypeOf||function(e,t){e.__proto__=t;return e})(e,t)}function y(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{Date.prototype.toString.call(Reflect.construct(Date,[],(function(){})));return!0}catch(e){return!1}}();return function(){var r,n=m(e);if(t){var o=m(this).constructor;r=Reflect.construct(n,arguments,o)}else r=n.apply(this,arguments);return v(this,r)}}function v(e,t){return!t||"object"!==a(t)&&"function"!=typeof t?b(e):t}function b(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function m(e){return(m=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function g(e,t,r){t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r;return e}!function(e){e.ANONYMOUS="anonymous";e.DEFAULT=""}(n||(n={}));var O=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}});t&&h(e,t)}(r,e);var t=y(r);function r(e,n){var s;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,r);g(b(s=t.call(this,e)),"pendingRequest",void 0);g(b(s),"scope","auth_base");g(b(s),"appId",void 0);g(b(s),"appSecret",void 0);g(b(s),"isvAppId",void 0);g(b(s),"ua",void 0);g(b(s),"authorizeOptions",void 0);g(b(s),"accessToken",void 0);g(b(s),"getAuthCode",void 0);g(b(s),"httpRequest",void 0);g(b(s),"currentAuthType",void 0);Object(o.assert)(n.getAuthCode,"[UserService]初始化时缺少 getAuthCode 参数");Object(o.assert)(n.request,"[UserService]初始化时缺少 request 参数");Object(o.assert)(n.appId,"[UserService]初始化时缺少 appId 参数");Object(o.assert)(n.appSecret,"[UserService]初始化时缺少 appSecret 参数");s.getAuthCode=n.getAuthCode;s.httpRequest=n.request;s.appId=n.appId;s.appSecret=n.appSecret;s.isvAppId=n.isvAppId;s.ua=n.ua;return s}!function(e,t,r){t&&d(e.prototype,t);r&&d(e,r)}(r,[{key:"authorize",value:function(){var e=l(regeneratorRuntime.mark((function e(){var t,r=arguments;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=r.length>0&&void 0!==r[0]?r[0]:{authType:n.DEFAULT,authProvider:"alipay_openapi"};this.validate(s,{options:t});if(t.authType!==n.ANONYMOUS){e.next=10;break}e.next=5;return this.anonymousAuthorizeHandler(t);case 5:if(!this.accessToken){e.next=7;break}return e.abrupt("return",{success:!0});case 7:return e.abrupt("return",{success:!1});case 10:if(this.accessToken&&(!this.accessToken||this.currentAuthType===t.authType)){e.next=16;break}e.next=13;return this.authorizeHandler(t);case 13:if(!this.accessToken){e.next=15;break}return e.abrupt("return",{success:!0});case 15:return e.abrupt("return",{success:!1});case 16:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"getInfo",value:function(){var e=l(regeneratorRuntime.mark((function e(t){var r,n,o;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.validate(i,{options:t});r=this.getEncoder();n={};this.authorizeOptions&&(n=p({},this.authorizeOptions));t&&(n=p({},t));this.currentAuthType&&(n={authType:this.currentAuthType});r.setBodyField({method:"serverless.auth.user.getProfileInfo",params:n});e.next=9;return this.transport.request(r);case 9:o=e.sent;return e.abrupt("return",o.body);case 11:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"setRequestToken",value:function(){var e=l(regeneratorRuntime.mark((function e(t){var r,o=arguments;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=o.length>1&&void 0!==o[1]&&o[1];if(!this.pendingRequest){e.next=5;break}this.transport.logger.info("[UserService]pendingRequest...");e.next=5;return this.pendingRequest;case 5:if(this.accessToken){e.next=7;break}throw new u.UnauthorizedError("[UserService]未进行用户授权，请先手动调用三方授权或匿名授权方法");case 7:if(!r||!this.authorizeOptions){e.next=14;break}this.transport.logger.info("getAccessToken: start");if(this.authorizeOptions.authType!==n.ANONYMOUS){e.next=12;break}e.next=12;return this.anonymousAuthorizeHandler(this.authorizeOptions);case 12:e.next=14;return this.authorizeHandler(this.authorizeOptions);case 14:t.setBodyField({token:this.accessToken});t.sign(this.appSecret);t.setBaseHeaders({"Content-Type":"application/json","x-basement-token":this.accessToken});return e.abrupt("return",t);case 18:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"authorizeHandler",value:function(){var e=l(regeneratorRuntime.mark((function e(t){var r=this;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.pendingRequest=this.getAuthCode({scopes:this.scope}).then((function(e){r.transport.logger.info("[UserService]Request authcode is ".concat(e.body.authCode," "));return e.body.authCode})).then((function(e){var n=r.getEncoder();n.setBodyField({method:"serverless.auth.user.authorize",params:{authProvider:t.authProvider||"alipay_openapi",clientIdentifier:r.appId,authCode:e,isvAppId:r.isvAppId}});n.sign(r.appSecret);n.setBaseHeaders({"Content-Type":"application/json"});r.ua&&n.setBaseHeaders({"x-serverless-ua":r.ua});var o=n.encodeAsHTTPRequestObject({timeout:r.transport.timeoutOption,dataType:"json"});return r.httpRequest(o)})).then((function(e){r.transport.logger.info("[UserService]Request accessToken "+(e.body.success?"success":"failed"));if(e.body&&e.body.result){r.authorizeOptions=t;r.accessToken=e.body.result.accessToken;r.currentAuthType=n.DEFAULT}r.pendingRequest=null;return Promise.resolve(r.accessToken)}));return e.abrupt("return",this.pendingRequest);case 2:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"anonymousAuthorizeHandler",value:function(){var e=l(regeneratorRuntime.mark((function e(t){var r,o,s=this;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:(r=this.getEncoder()).setBodyField({method:"serverless.auth.user.anonymousAuthorize",params:{clientIdentifier:this.appId,isvAppId:this.isvAppId}});r.sign(this.appSecret);r.setBaseHeaders({"Content-Type":"application/json"});this.ua&&r.setBaseHeaders({"x-serverless-ua":this.ua});o=r.encodeAsHTTPRequestObject({timeout:this.transport.timeoutOption,dataType:"json"});this.pendingRequest=this.httpRequest(o).then((function(e){s.transport.logger.info("[UserService]Request accessToken "+(e.body.success?"success":"failed"));if(e.body&&e.body.result){s.authorizeOptions=t;s.accessToken=e.body.result.accessToken;s.currentAuthType=n.ANONYMOUS}s.pendingRequest=null;return Promise.resolve(s.accessToken)}));return e.abrupt("return",this.pendingRequest);case 8:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"validate",value:function(e,t){var r=new o.Validator;try{r.validate(e,t)}catch(e){throw e}}}]);return r}(o.BaseService)},"@alicloud/mpserverless-core":function(t,r){t.exports=e}})}));